name: PR Precheck

on:
  pull_request:
    branches-ignore:
      - master

jobs:
  conflict-check:
    name: Conflict Check
    runs-on: ubuntu-latest
    outputs:
      conflict: ${{ steps.check-conflicts.outputs.conflict }}

    steps:
      - name: Checkout code
        uses: "actions/checkout@v4"
        with:
          fetch-depth: 0

      - name: Check Conflicts
        id: check-conflicts
        run: |
          git fetch origin master
          conflicts=$(git diff --name-only --diff-filter=U origin/master...HEAD || true)
          if [ -n "$conflicts" ]; then
            echo "conflict=true" >> $GITHUB_OUTPUT
            echo "Conflicts detected in files: $conflicts"
          else
            echo "conflict=false" >> $GITHUB_OUTPUT
            echo "No conflicts detected"
          fi

  labeler:
    name: Add Conflict Label
    runs-on: ubuntu-latest
    needs: conflict-check
    if: needs.conflict-check.outputs.conflict == 'true'

    steps:
      - name: Add conflict label
        uses: "actions/github-script@v7"
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['conflict']
            })
